name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Framework Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          for file in $(find . -name "*.json" -not -path "./node_modules/*" -not -path "./.git/*"); do
            echo "Checking $file"
            python3 -m json.tool "$file" > /dev/null || { echo "Invalid JSON: $file"; exit 1; }
          done
          echo "All JSON files are valid"

      - name: Check skill definitions exist
        run: |
          echo "Checking required skill definitions..."
          SKILLS=(
            ".claude/skills/discovering-requirements/SKILL.md"
            ".claude/skills/designing-architecture/SKILL.md"
            ".claude/skills/planning-sprints/SKILL.md"
            ".claude/skills/implementing-tasks/SKILL.md"
            ".claude/skills/reviewing-code/SKILL.md"
            ".claude/skills/deploying-infrastructure/SKILL.md"
            ".claude/skills/auditing-security/SKILL.md"
            ".claude/skills/translating-for-executives/SKILL.md"
          )
          for skill in "${SKILLS[@]}"; do
            if [ ! -f "$skill" ]; then
              echo "Missing required skill: $skill"
              exit 1
            fi
          done
          echo "All required skills present"

      - name: Check command definitions exist
        run: |
          echo "Checking required command definitions..."
          COMMANDS=(
            ".claude/commands/plan-and-analyze.md"
            ".claude/commands/architect.md"
            ".claude/commands/sprint-plan.md"
            ".claude/commands/implement.md"
            ".claude/commands/review-sprint.md"
            ".claude/commands/audit-sprint.md"
            ".claude/commands/deploy-production.md"
            ".claude/commands/audit.md"
            ".claude/commands/setup.md"
            ".claude/commands/feedback.md"
            ".claude/commands/update.md"
          )
          for cmd in "${COMMANDS[@]}"; do
            if [ ! -f "$cmd" ]; then
              echo "Missing required command: $cmd"
              exit 1
            fi
          done
          echo "All required commands present"

      - name: Check documentation exists
        run: |
          echo "Checking required documentation..."
          DOCS=(
            "README.md"
            "CLAUDE.md"
            "PROCESS.md"
            "CONTRIBUTING.md"
            "SECURITY.md"
            "CHANGELOG.md"
            "LICENSE.md"
          )
          for doc in "${DOCS[@]}"; do
            if [ ! -f "$doc" ]; then
              echo "Missing required documentation: $doc"
              exit 1
            fi
          done
          echo "All required documentation present"

      - name: Validate version consistency
        run: |
          echo "Checking version consistency..."

          # Get version from CHANGELOG
          CHANGELOG_VERSION=$(grep -oP '## \[\K[0-9]+\.[0-9]+\.[0-9]+' CHANGELOG.md | head -1)
          echo "CHANGELOG version: $CHANGELOG_VERSION"

          # Get version from README badge
          README_VERSION=$(grep -oP 'version-\K[0-9]+\.[0-9]+\.[0-9]+' README.md | head -1)
          echo "README version: $README_VERSION"

          if [ "$CHANGELOG_VERSION" != "$README_VERSION" ]; then
            echo "Version mismatch: CHANGELOG=$CHANGELOG_VERSION, README=$README_VERSION"
            exit 1
          fi

          echo "Versions are consistent: $CHANGELOG_VERSION"

      - name: Check for broken internal links
        run: |
          echo "Checking for broken internal links in documentation..."

          # Check that referenced files exist
          LINKS_OK=true

          for mdfile in README.md CLAUDE.md PROCESS.md CONTRIBUTING.md; do
            # Extract markdown links like [text](file.md) or [text](./path/file.md)
            grep -oP '\[.*?\]\(\K[^)]+(?=\))' "$mdfile" 2>/dev/null | while read link; do
              # Skip external URLs
              if [[ "$link" == http* ]] || [[ "$link" == "#"* ]]; then
                continue
              fi

              # Check if file exists
              if [ ! -f "$link" ] && [ ! -d "$link" ]; then
                echo "Broken link in $mdfile: $link"
                LINKS_OK=false
              fi
            done
          done

          if [ "$LINKS_OK" = false ]; then
            exit 1
          fi

          echo "All internal links are valid"

  markdown-lint:
    name: Lint Markdown
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Create markdownlint config
        run: |
          cat > .markdownlint.json << 'EOF'
          {
            "default": true,
            "MD013": false,
            "MD033": false,
            "MD041": false,
            "MD024": { "siblings_only": true }
          }
          EOF

      - name: Lint Markdown files
        run: markdownlint '**/*.md' --ignore node_modules --ignore loa-grimoire || true
        # Note: Using || true to not fail on lint warnings for now
        # Remove || true once all markdown is cleaned up

  yaml-lint:
    name: Lint YAML
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: yamllint .github/ || true
        # Note: Using || true to not fail on lint warnings for now

  # --- Loa Skills Registry CI Jobs ---
  # @see sprint.md T1.5: CI/CD Pipeline

  registry-lint:
    name: Registry - Lint & Type Check
    runs-on: ubuntu-latest
    # Only run if apps/ or packages/ directories exist
    if: hashFiles('apps/**') != '' || hashFiles('packages/**') != ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript check
        run: pnpm typecheck

      - name: Run ESLint
        run: pnpm lint

  registry-test:
    name: Registry - Unit Tests
    runs-on: ubuntu-latest
    needs: registry-lint
    if: hashFiles('apps/**') != '' || hashFiles('packages/**') != ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests with coverage
        run: pnpm test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  registry-build:
    name: Registry - Build
    runs-on: ubuntu-latest
    needs: [registry-lint, registry-test]
    if: hashFiles('apps/**') != '' || hashFiles('packages/**') != ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Upload API build artifact
        uses: actions/upload-artifact@v6
        with:
          name: api-build
          path: apps/api/dist
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Web build artifact
        uses: actions/upload-artifact@v6
        with:
          name: web-build
          path: apps/web/.next
          retention-days: 7
          if-no-files-found: ignore

  registry-e2e:
    name: Registry - E2E Tests
    runs-on: ubuntu-latest
    needs: registry-build
    if: hashFiles('apps/web/e2e/**') != ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: cd apps/web && npx playwright install --with-deps chromium

      - name: Build application
        run: pnpm build

      - name: Run E2E tests
        run: cd apps/web && pnpm test:e2e --project=chromium
        env:
          CI: true

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: playwright-report
          path: apps/web/playwright-report/
          retention-days: 7
          if-no-files-found: ignore
